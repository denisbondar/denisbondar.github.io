<!doctype html><html lang=uk dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Настройка собственного OpenVPN сервера # Регистрация собственного виртуального сервера # Существует множество хостинговых компаний, предоставляющих в аренду виртуальные серверы за относительно небольшую плату, порядка $5 в месяц. Даже самых простых и дешевых виртуальных серверов обычно достаточно для использования в качестве VPN-сервера.
Одна из таких компаний — «Digital Ocean». Виртуальные серверы в терминологии этой компании называются каплями (Droplets) и могут быть различной производительности. Капли можно создавать как на базе образов популярных операционных систем, так и на базе множества других образов, как доступных прямо в панели управления Digital Ocean так и собственных, которые можно загрузить самостоятельно."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="OpenVPN Server"><meta property="og:description" content="Настройка собственного OpenVPN сервера # Регистрация собственного виртуального сервера # Существует множество хостинговых компаний, предоставляющих в аренду виртуальные серверы за относительно небольшую плату, порядка $5 в месяц. Даже самых простых и дешевых виртуальных серверов обычно достаточно для использования в качестве VPN-сервера.
Одна из таких компаний — «Digital Ocean». Виртуальные серверы в терминологии этой компании называются каплями (Droplets) и могут быть различной производительности. Капли можно создавать как на базе образов популярных операционных систем, так и на базе множества других образов, как доступных прямо в панели управления Digital Ocean так и собственных, которые можно загрузить самостоятельно."><meta property="og:type" content="article"><meta property="og:url" content="https://denisbondar.github.io/post/openvpn-server/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-03-19T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-19T00:00:00+00:00"><title>OpenVPN Server | Notes</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.6e9dc01763201e1138d92988ddb76ac12def039312e5473a6847a96d89bc05af.css integrity="sha256-bp3AF2MgHhE42SmI3bdqwS3vA5MS5Uc6aEepbYm8Ba8=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/uk.search.min.48f7ca0f53c979aaa40e09850a1ee3a56262959e0a75a0ae36e09883bd5bc879.js integrity="sha256-SPfKD1PJeaqkDgmFCh7jpWJilZ4KdaCuNuCYg71byHk=" crossorigin=anonymous></script><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-8991816-14","auto"),ga("send","pageview"))</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Notes</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Пошук aria-label=Пошук maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/post/winbox-macos-retina/>Launching Winbox on macOS</a></li><li><a href=/post/openvpn-server/ class=active>OpenVPN Server</a></li><li><a href=/post/alpine-php-nginx-logrotate-docker-image/>Докеризация PHP-приложения в единый Docker-образ Alpine+PHP+NGINX+logrotate</a></li><li><a href=/post/postfix-dkim-spf-tls-dmarc/>Персональный почтовый сервер</a></li><li><a href=/post/winbox-wine-tahoma-font/>Winbox в Wine как исправить кривой шрифт</a></li><li><a href=/post/how-to-install-docker-on-linux/>Установка Docker в Linux</a></li><li><a href=/post/phpstorm_docker_xdebug/>PhpStorm + Docker + Xdebug</a></li><li><a href=/post/zfs-manual-rus/>ZFS — Справочник команд</a></li><li><a href=/post/midi-keybiard-jack-bitwig-studio/>Как подключить MIDI клавиатуру к Bitwig Studio</a></li><li><a href=/post/how-to-install-debian-8/>Как установить Debian 8 без знаний и опыта</a></li><li><a href=/post/install-nginx-php7-mysql57-mariadb11-debian-ubuntu/>Установка Nginx 1.13, PHP 7, MySQL 5.7, MariaDB 10.1, PostgreSQL 11 в Debian и Ubuntu</a></li><li><a href=/post/asterisk-13-chan_dongle-debian-8/>Установка Asterisk 13 + chan_dongle (E1550, E1750) на Debian 8</a></li><li><a href=/post/asterisk11-chan_dongle_e1550-ubuntu14/>Asterisk11 Chan_dongle_e1550 Ubuntu14</a></li><li><a href=/post/asterisk-example-2-dongle-call-management/>Asterisk. Пример 2 — SIP и DONGLE</a></li><li><a href=/post/apache24php7win10/>Apache 2.4 + PHP 7 на Windows 7­, 10</a></li><li><a href=/post/simply-install-freebsd/>Как установить FreeBSD с флешки</a></li><li><a href=/post/resize-gpt-psrtition-freebsd/>Изменить размер раздела GPT FreeBSD vmWare</a></li><li><a href=/post/material-design-product-icon-ai/>Как создать иконку приложения в стиле Material Design. Наиболее правильная инструкция</a></li><li><a href=/post/asterisk-example-1-call-between-two-sip-line/>Asterisk. Пример 1 — вызов между двумя линиями SIP</a></li><li><a href=/post/manual-freebsd-install/>Ручная установка FreeBSD на USB flash или HDD</a></li><li><a href=/post/apache24php56win7/>Apache 2.4 + PHP 5.6 + MySQL 5.6 на Windows 7, 10</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>OpenVPN Server</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#регистрация-собственного-виртуального-сервера>Регистрация собственного виртуального сервера</a><ul><li><a href=#создание-капли>Создание капли</a></li></ul></li><li><a href=#установка>Установка</a><ul><li><a href=#openvpn>OpenVPN</a></li><li><a href=#easyrsa-3>EasyRSA-3</a></li><li><a href=#easytls>EasyTLS</a></li></ul></li><li><a href=#инфраструктура-открытых-ключей-pki>Инфраструктура открытых ключей (PKI)</a><ul><li><a href=#что-такое-easyrsa>Что такое EasyRSA</a></li><li><a href=#инициализация-pki>Инициализация PKI</a></li><li><a href=#предварительная-конфигурация>Предварительная конфигурация</a></li><li><a href=#создание-главного-сертификата--ca>Создание главного сертификата — CA</a></li><li><a href=#создание-сертификата-сервера>Создание сертификата сервера</a></li><li><a href=#создание-сертификата-клиента>Создание сертификата клиента</a></li><li><a href=#инициализация-и-создание-tls-ключа>Инициализация и создание TLS-ключа</a></li></ul></li><li><a href=#сервер>Сервер</a><ul><li><a href=#конфигурация-openvpn-сервера>Конфигурация OpenVPN сервера</a></li><li><a href=#настройка-сети-сервера>Настройка сети сервера</a></li><li><a href=#запуск-openvpn-сервера>Запуск OpenVPN сервера</a></li></ul></li><li><a href=#клиент>Клиент</a><ul><li><a href=#настройка-клиента>Настройка клиента</a></li></ul></li><li><a href=#routeros-и-mikrotik>RouterOS и MikroTik</a><ul><li><a href=#создание-подключения-на-mikrotik>Создание подключения на MikroTik</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=настройка-собственного-openvpn-сервера>Настройка собственного OpenVPN сервера
<a class=anchor href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%b3%d0%be-openvpn-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0>#</a></h1><h2 id=регистрация-собственного-виртуального-сервера>Регистрация собственного виртуального сервера
<a class=anchor href=#%d1%80%d0%b5%d0%b3%d0%b8%d1%81%d1%82%d1%80%d0%b0%d1%86%d0%b8%d1%8f-%d1%81%d0%be%d0%b1%d1%81%d1%82%d0%b2%d0%b5%d0%bd%d0%bd%d0%be%d0%b3%d0%be-%d0%b2%d0%b8%d1%80%d1%82%d1%83%d0%b0%d0%bb%d1%8c%d0%bd%d0%be%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0>#</a></h2><p>Существует множество хостинговых компаний, предоставляющих в аренду виртуальные серверы за относительно небольшую плату, порядка $5 в месяц.
Даже самых простых и дешевых виртуальных серверов обычно достаточно для использования в качестве VPN-сервера.</p><p>Одна из таких компаний — «Digital Ocean». Виртуальные серверы в терминологии этой компании называются каплями <em>(Droplets)</em> и могут быть различной производительности.
Капли можно создавать как на базе образов популярных операционных систем, так и на базе множества других образов, как доступных прямо в панели управления Digital Ocean так и собственных, которые можно загрузить самостоятельно.
Данная инструкция предполагает, что используется чистая операционная система Linux дистрибутива Debian или его производных (например, Ubuntu).
Для других дистрибутивов придется использовать другие команды в некоторых местах данной инструкции, так что лучше всего использовать рекомендуемый Debian.</p><p>Вместо этого Вы можете развернуть Каплю на основе готового образа OpenVPN, который существует в панели Digital Ocean, но этот способ мной не проверялся и я ничего не могу сказать об удобстве его использования.</p><p>Кроме того, Вы можете получить кредит на $100 на два месяца, который Вы можете тратить на любые услуги Digital Ocean, чтобы попробовать всё, что вам хочется.
Для этого достаточно <a href=https://m.do.co/c/766480a2686b>зарегистрировать учетную запись в Digital Ocean по специальной реферальной ссылке</a>.</p><p>В любом случае, при регистрации в Digital Ocean Вы должны будете подключить банковскую карту (или PayPal) для списаний в будущем, если продолжите пользоваться Digital Ocean.
При регистрации Digital Ocean списывает с карты сумму приблизительно $5 для верификации карты и через время возвращает обратно.</p><h3 id=создание-капли>Создание капли
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d0%ba%d0%b0%d0%bf%d0%bb%d0%b8>#</a></h3><p>После регистрации создайте каплю (droplet). Для этого находясь в панели по адресу <a href=https://cloud.digitalocean.com/>https://cloud.digitalocean.com/</a> нажмите вверху зеленую кнопку <strong>Create</strong> и выберите там <strong>Droplets</strong>.
Затем выберите образ (Image): <strong>Ubuntu</strong> или <strong>Debian</strong>. Затем выберите план: <strong>Basic</strong>. CPU-options: <strong>Regular Intel with SSD</strong>. Самый минимальный дроплет за $5. Листайте ниже.
На панели выбора «Choose a datacenter region» выберите регион расположения вашего виртуального сервера: подойдет любой европейский регион. Ниже на панели Аутентификации выберите аутентификацию по RSA-ключу или паролю, как вам удобно.
Среди дополнительных опций не нужно выбирать ничего (можно, разве что, выбрать Монторинг, но он Вам все равно не пригодится). По желанию можете указать имя хоста в поле «Choose a hostname».</p><p>На этом всё. Нажмите большую зеленую кнопку «Create Droplet».</p><p>Через несколько минут капля будет создана и появится в панели Droplets, где Вы сможете скопировать ее IP-адрес. Теперь Вы сможете подключиться к ней используя имя пользователя <code>root</code> и пароль или RSA-ключ, смотря какой способ аутентификации выбрали.</p><p>Если на Вашем компьютере установлен Windows, то используйте приложение <a href=https://www.chiark.greenend.org.uk/~sgtatham/putty/>PuTTY</a> для подключения по протоколу SSH к серверу. Если установлен Linux или MacOS, то просто введите команду:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh root@droplet_ip-addr
</span></span></code></pre></div><p>Вместо <code>droplet_ip-addr</code> укажите IP-адрес вашей капли.</p><h2 id=установка>Установка
<a class=anchor href=#%d1%83%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%ba%d0%b0>#</a></h2><p>Вам необходимо установить <strong>OpenVPN</strong>, <strong>EasyRSA</strong> и <strong>EasyTLS</strong> (если не планируется использовать MikroTik в качестве клиентов).</p><h3 id=openvpn>OpenVPN
<a class=anchor href=#openvpn>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt full-upgrade -y
</span></span><span style=display:flex><span>sudo apt install openvpn -y
</span></span></code></pre></div><h3 id=easyrsa-3>EasyRSA-3
<a class=anchor href=#easyrsa-3>#</a></h3><p><a href=https://github.com/OpenVPN/easy-rsa>Ссылка</a> на репозиторий.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cd ~
</span></span><span style=display:flex><span>wget -O easyrsa.tgz https://github.com/OpenVPN/easy-rsa/releases/download/v3.1.0/EasyRSA-3.1.0.tgz
</span></span><span style=display:flex><span>tar xf easyrsa.tgz
</span></span><span style=display:flex><span>rm easyrsa.tgz
</span></span><span style=display:flex><span>mv EasyRSA-3.1.0 easyrsa
</span></span><span style=display:flex><span>cd easyrsa
</span></span></code></pre></div><blockquote class="book-hint warning"><strong>Важно!</strong> Каталог <code>easyrsa</code> является текущим каталогом на всей протяженности данной инструкции.</blockquote><h3 id=easytls>EasyTLS
<a class=anchor href=#easytls>#</a></h3><p>Обратите внимание, что <strong>RouterOS</strong> (оборудование MikroTik) не поддерживает TLS-аутентификацию и, если планируется использовать MikroTik в качестве клиента, устанавливать EasyTLS не нужно. Также ненужно включать в конфигурацию параметры, связанные с TLS и TLS-ключ.</p><p><a href=https://github.com/TinCanTech/easy-tls>Ссылка</a> на репозиторий.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wget -O easytls https://raw.githubusercontent.com/TinCanTech/easy-tls/master/easytls
</span></span><span style=display:flex><span>chmod a+x easytls
</span></span></code></pre></div><h2 id=инфраструктура-открытых-ключей-pki>Инфраструктура открытых ключей (PKI)
<a class=anchor href=#%d0%b8%d0%bd%d1%84%d1%80%d0%b0%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%82%d1%83%d1%80%d0%b0-%d0%be%d1%82%d0%ba%d1%80%d1%8b%d1%82%d1%8b%d1%85-%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%b9-pki>#</a></h2><h3 id=что-такое-easyrsa>Что такое EasyRSA
<a class=anchor href=#%d1%87%d1%82%d0%be-%d1%82%d0%b0%d0%ba%d0%be%d0%b5-easyrsa>#</a></h3><p><strong>EasyRSA</strong> — это инструмент для управления <em>инфраструктурой открытых ключей</em> (<strong>X.509</strong> PKI), которая основана на понятии доверия к конкретному органу для аутентификации удаленного клиента.</p><h4 id=основные-понятия>Основные понятия
<a class=anchor href=#%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%bd%d1%8b%d0%b5-%d0%bf%d0%be%d0%bd%d1%8f%d1%82%d0%b8%d1%8f>#</a></h4><ul><li><strong>PKI</strong> — Public Key Infrastructure <em>(инфраструктурой открытых ключей)</em>. Описывает коллекцию файлов и ассоциации между ЦС, парами ключей, запросами и сертификатами.</li><li><strong>CA</strong> — Certificate Authority <em>(центр сертификации, ЦС)</em>. Это «главный сертификат» в корне PKI. Является сердцем PKI и наиболее чувствительным к безопасности. Закрытый ключ ЦС используется для подписания всех выпущенных сертификатов, поэтому <strong>его безопасность критически важна</strong> для обеспечения безопасности всей PKI. Рекомендуется хранить CA на максимально безопасной системе, а не на той, где генерируются и используются сертификаты конечных объектов. (Но для простого VPN сервера, используемого для удаленного доступа в интернет, это правило можно мягко игнорировать).</li><li><strong>cert</strong> — Certificate <em>(сертификат)</em> — это <em>запрос</em>, подписанный <em>центром сертификации</em>. Сертификат содержит открытый ключ, некоторые детали, описывающие сам сертификат, и цифровую подпись ЦС.</li><li><strong>request</strong> — Certificate Request <em>(запрос сертификата)</em>, иногда просто «req» <em>(просто «запрос»)</em>. Запрос на сертификат, который после создания отправляется в <em>центр сертификации</em> для подписания. <em>Запрос</em> содержит требуемую информацию о сертификате вместе с цифровой подписью закрытого ключа. Запрос не чувствителен к безопасности и может быть передан любыми открытыми каналами. Чтобы удостовериться в аутентичности запроса, можно, например, использовать проверку его контрольной суммы.</li><li><strong>keypair</strong> — <em>(пара ключей)</em> — это <em>асимметричная криптографическая пара</em> ключей. Эти ключи делятся на две части: <em>открытый</em> и <em>закрытый</em> ключи. Открытый ключ содержится в запросе и сертификате.</li></ul><blockquote class="book-hint warning"><p><strong>Обратите внимание!</strong></p><p>Так как эта статья посвещена настройке простого VPN-сервера для удаленного доступа в Интернет и не предполагает никаких сложных настроек безопасности, то и Центр Сертификации и сертификаты сервера и клиента будут созданы на одном и том же хосте — на том, где установлен OpenVPN сервер, без использования запросов сертификатов (поскольку сертификаты будут генерироваться и подписываться сразу же в PKI). Абсолютно то же самое можно сделать и на своем домашнем компьютере.</p><p>Если же Вам нужен корпоративный VPN сервер с управлением доступом к нему на уровне сертификатов с достаточно высоким уровнем безопасности, обратитесь, пожалуйста, к соответствующей документации и статьям в интернете. В таком случае крейне рекомендую начать с более углубленного изучения основ, чтобы четко понимать, как это работает, что Вы делаете и для чего.</p></blockquote><h3 id=инициализация-pki>Инициализация PKI
<a class=anchor href=#%d0%b8%d0%bd%d0%b8%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-pki>#</a></h3><p>Предполагается, что текущий каталог <code>easyrsa</code>, в который был осуществлен переход в разделе установки EasyRSA-3. Выполните:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./easyrsa init-pki
</span></span></code></pre></div><p>В результате будет создан подкаталог <code>pki</code>, содержащий необходимые файлы.</p><h3 id=предварительная-конфигурация>Предварительная конфигурация
<a class=anchor href=#%d0%bf%d1%80%d0%b5%d0%b4%d0%b2%d0%b0%d1%80%d0%b8%d1%82%d0%b5%d0%bb%d1%8c%d0%bd%d0%b0%d1%8f-%d0%ba%d0%be%d0%bd%d1%84%d0%b8%d0%b3%d1%83%d1%80%d0%b0%d1%86%d0%b8%d1%8f>#</a></h3><p>Если есть необходимость изменения базовых переменных (для простого доступа в интернет через VPN в этом нет необходимости), отредактируйте файл <code>vars</code> в только что созданном каталоге <code>pki</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nano pki/vars
</span></span></code></pre></div><p>Не забудьте удалить комментарии строк с переменными, значения которых необходимо изменить.</p><p>Скорее всего будет интересен следующий блок переменных:</p><pre tabindex=0><code>#set_var EASYRSA_REQ_COUNTRY    &#34;US&#34;
#set_var EASYRSA_REQ_PROVINCE   &#34;California&#34;
#set_var EASYRSA_REQ_CITY       &#34;San Francisco&#34;
#set_var EASYRSA_REQ_ORG        &#34;Copyleft Certificate Co&#34;
#set_var EASYRSA_REQ_EMAIL      &#34;me@example.net&#34;
#set_var EASYRSA_REQ_OU         &#34;My Organizational Unit&#34;
</code></pre><p>Также может быть необходимо изменить количество дней действия сертификата ЦС и конечных сертификатов:</p><pre tabindex=0><code>#set_var EASYRSA_CA_EXPIRE      3650
#set_var EASYRSA_CERT_EXPIRE    825
</code></pre><h3 id=создание-главного-сертификата--ca>Создание главного сертификата — CA
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d0%b3%d0%bb%d0%b0%d0%b2%d0%bd%d0%be%d0%b3%d0%be-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%b0--ca>#</a></h3><p>Для создания главного сертификата выполните:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./easyrsa build-ca nopass
</span></span></code></pre></div><p>Здесь для создания CA указан параметр <code>nopass</code>, означающий, что <em>закрытый ключ</em> будет создан <strong>без пароля</strong>. Это очень небезопасный способ создания ЦС, однако, учитывая поставленную цель, более удобный, т.к. не придется далее вводить каждый раз пароль закрытого ключа. Если считаете это неприемлемым в вашем случае, не используйте параметр <code>nopass</code>.</p><p>При создании сертификата будет предложено указать <code>Common Name</code>, но в данной конфигурации можно просто оставить значение по умолчанию — <strong>CA</strong>.</p><p>После этого действия будет создан файл сертификата ЦС <code>pki/ca.crt</code> и файл закрытого ключа <code>pki/private/ca.key</code> (он является секретным).</p><h3 id=создание-сертификата-сервера>Создание сертификата сервера
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%b0-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0>#</a></h3><p>Создадим сертификат сервера с именем <code>server</code>. Имя может быть любым, но в данном случае удобней, если оно будет именно таким.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./easyrsa build-server-full server nopass
</span></span></code></pre></div><p>Будет создан сертификат сервера <code>pki/issued/server.crt</code> и приватный ключ <code>pki/private/server.key</code> (он является секретным).</p><h3 id=создание-сертификата-клиента>Создание сертификата клиента
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%b0-%d0%ba%d0%bb%d0%b8%d0%b5%d0%bd%d1%82%d0%b0>#</a></h3><p>Для данной задачи создадим один единственный сертификат клиента с именем <code>client</code>, который будем испльзовать на всех своих устройствах и даже на не своих устройствах тоже. Для решения поставленной задачи этого более чем достаточно.</p><p>Если же есть необходимость в создании разных сертификатов, то указывайте для каждого из них понятное имя.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./easyrsa build-client-full client nopass
</span></span></code></pre></div><p>Будет создан сертификат сервера <code>pki/issued/client.crt</code> и приватный ключ <code>pki/private/client.key</code> (он является секретным).</p><h3 id=инициализация-и-создание-tls-ключа>Инициализация и создание TLS-ключа
<a class=anchor href=#%d0%b8%d0%bd%d0%b8%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d0%b8-%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-tls-%d0%ba%d0%bb%d1%8e%d1%87%d0%b0>#</a></h3><p>Обратите внимание, что <strong>RouterOS</strong> (оборудование MikroTik) <strong>не поддерживает TLS-аутентификацию</strong> и, если планируется использовать MikroTik в качестве клиента, создавать TLS-ключ не нужно.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./easytls init-tls
</span></span><span style=display:flex><span>./easytls build-tls-crypt
</span></span></code></pre></div><p>Будет создан файл ключа <code>pki/easytls/tls-crypt.key</code>.</p><h2 id=сервер>Сервер
<a class=anchor href=#%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80>#</a></h2><h3 id=конфигурация-openvpn-сервера>Конфигурация OpenVPN сервера
<a class=anchor href=#%d0%ba%d0%be%d0%bd%d1%84%d0%b8%d0%b3%d1%83%d1%80%d0%b0%d1%86%d0%b8%d1%8f-openvpn-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0>#</a></h3><p>Содержимое файлов сертификатов и ключей можно вставить прямо в конфигурационный файл сервера. Для этого нужно сначала создать заголовок конфигурационного файла, а затем вставить в него все необходимые ключи.</p><p>Создайте файл <code>/etc/openvpn/server.conf</code> с конфигурацией сервера:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo tee /etc/openvpn/server.conf <span style=color:#e6db74>&lt;&lt;EOT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>port 1194
</span></span></span><span style=display:flex><span><span style=color:#e6db74>proto tcp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>local ::
</span></span></span><span style=display:flex><span><span style=color:#e6db74>dev-type tun
</span></span></span><span style=display:flex><span><span style=color:#e6db74>dev tun1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>user nobody
</span></span></span><span style=display:flex><span><span style=color:#e6db74>group nogroup
</span></span></span><span style=display:flex><span><span style=color:#e6db74>topology subnet
</span></span></span><span style=display:flex><span><span style=color:#e6db74>persist-key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>persist-tun
</span></span></span><span style=display:flex><span><span style=color:#e6db74>server 10.100.0.0 255.255.255.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>remote-cert-tls client
</span></span></span><span style=display:flex><span><span style=color:#e6db74>tls-version-min 1.2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384:TLS-ECDHE-ECDSA-WITH-AES-256-GCM-SHA384
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>; Если TLS не используется, то заменить шифр AES-256-GCM на AES-256-CBC
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ncp-ciphers AES-256-GCM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cipher AES-256-GCM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>; Если среди клиентов есть RouterOS, то раскомментировать следующую строку
</span></span></span><span style=display:flex><span><span style=color:#e6db74>;auth sha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>dh none
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>reneg-sec 36000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>max-clients 128
</span></span></span><span style=display:flex><span><span style=color:#e6db74>keepalive 10 120
</span></span></span><span style=display:flex><span><span style=color:#e6db74>script-security 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>explicit-exit-notify 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>tcp-nodelay
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>push &#34;redirect-gateway def1 block-local&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>push &#34;block-outside-dns&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>push &#34;dhcp-option DNS 8.8.8.8&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>push &#34;dhcp-option DNS 1.1.1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>log /dev/null
</span></span></span><span style=display:flex><span><span style=color:#e6db74>;log /var/log/openvpn/openvpn-debug.log
</span></span></span><span style=display:flex><span><span style=color:#e6db74>;log-append /var/log/openvpn/openvpn-debug.log
</span></span></span><span style=display:flex><span><span style=color:#e6db74>status /var/log/openvpn/openvpn-status.log
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOT</span>
</span></span></code></pre></div><p>И теперь выполняйте следующие строки, чтобы добавить в этот файл необходимые сертификаты и ключи:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;ca&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>cat pki/ca.crt | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/ca&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;cert&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>cat pki/issued/server.crt | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/cert&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;key&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>cat pki/private/server.key | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/key&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Блок tls-crypt добавлять только если все клиенты поддерживают TLS</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;tls-crypt&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>cat pki/easytls/tls-crypt.key | sudo tee -a /etc/openvpn/server.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/tls-crypt&gt;&#34;</span> | sudo tee -a /etc/openvpn/server.conf
</span></span></code></pre></div><h3 id=настройка-сети-сервера>Настройка сети сервера
<a class=anchor href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d1%81%d0%b5%d1%82%d0%b8-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0>#</a></h3><h4 id=ip-forwarding-уровня-ядра>IP Forwarding уровня ядра
<a class=anchor href=#ip-forwarding-%d1%83%d1%80%d0%be%d0%b2%d0%bd%d1%8f-%d1%8f%d0%b4%d1%80%d0%b0>#</a></h4><p>Необходимо разрешить IP-пакетам ходить между интерфейсами сервера. Для этого выполните:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo tee -a /etc/sysctl.conf <span style=color:#e6db74>&lt;&lt;EOT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.ipv4.ip_forward=1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOT</span>
</span></span><span style=display:flex><span>sudo sysctl -p
</span></span></code></pre></div><h4 id=фаервол>Фаервол
<a class=anchor href=#%d1%84%d0%b0%d0%b5%d1%80%d0%b2%d0%be%d0%bb>#</a></h4><p>IP-пакетам, отправляемым из VPN-сети через шлюз, необходимо выполнять процедуру трансляции адресов. Это связано с тем, что IP-адреса VPN клиентов «серые» и не могут быть маршрутированы из интернет напряму. Точно так же, как это происходит в обычном домашнем маршрутизаторе. За это отвечает модуль фаервола — NAT.</p><h5 id=ufw>UFW
<a class=anchor href=#ufw>#</a></h5><p>Если до этого Вы не имели дел с фаерволом на данном сервере, то, скорее всего, он отключен. Чтобы включить его и управлять им, удобней всего использовать инструмент UFW.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo apt install -y ufw
</span></span></code></pre></div><p>Далее нужно будет включить фаервол, а перед тем, как это сделать, нужно сначала добавить правило, разрешающее подключение к порту 22 (SSH) и уже после этого активировать фаервол. Обратите внимание! Если вы изменяли порт для SSH, то вместо указания имени application нужно будет указать порт и протокол. Оба варианта представлены ниже:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># Если используется порт SSH по умолчанию</span>
</span></span><span style=display:flex><span>sudo ufw allow OpenSSH
</span></span><span style=display:flex><span><span style=color:#75715e># Если используется какой-то другой порт для SSH, например 2255</span>
</span></span><span style=display:flex><span>sudo ufw allow 2255/tcp
</span></span></code></pre></div><p>Также добавьте правило, <strong>разрешающее подключение к OpenVPN серверу</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo ufw allow 1194/tcp
</span></span></code></pre></div><p>Теперь нужно в разрешить фаерволу прохождение пакетов между интерфейсами (форвардинг на уровне фаервола). Для этого выполните:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo sed -i <span style=color:#e6db74>&#39;s@DEFAULT_FORWARD_POLICY=&#34;DROP&#34;@DEFAULT_FORWARD_POLICY=&#34;ACCEPT&#34;@&#39;</span> /etc/default/ufw
</span></span></code></pre></div><p>Активировать фаервол:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo ufw enable
</span></span></code></pre></div><p>Ответить <code>y</code> на просьбу подтвердить включение и убедиться, что после включения связь с сервером не потерялась. Также убедиться, что подключение по необходимым портам разрешено:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo ufw status
</span></span></code></pre></div><h5 id=nat>NAT
<a class=anchor href=#nat>#</a></h5><p>Теперь нужно настроить NAT. Сперва нужно узнать имя интерфейса, через который сервер подключен к интернет. Это можно сделать посмотрев на маршрут по умолчанию.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ip route | grep default
</span></span></code></pre></div><p>В выводе будет нечто подобное:</p><pre tabindex=0><code>default via 1.2.3.4 dev eth0 onlink
</code></pre><p>Значит интересующий нас интерфейс называется <code>eth0</code> — позже он пригодится для правила NAT фаервола.</p><p>Редактируем файл <code>/etc/ufw/before.rules</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo nano /etc/ufw/before.rules
</span></span></code></pre></div><p>Сразу после шапки файла (заголовка с комментариями) перед блоком с правилами <code>*filter</code> добавляем блок с настройками <strong>NAT</strong>, предварительно убедившись в корректности имени интерфейса <code>-o eth0</code>:</p><pre tabindex=0><code># START OPENVPN RULES
# NAT table rules
*nat
:POSTROUTING ACCEPT [0:0] 
# Allow traffic from OpenVPN client to eth0 (change to the interface you discovered!)
-A POSTROUTING -s 10.100.0.0/24 -o eth0 -j MASQUERADE
COMMIT
# END OPENVPN RULES
</code></pre><p>Обратите внимание, если Вы изменяли адрес подсети в конфигурации сервера выше, то не забудьте здесь также указать эту подсеть и корректную маску.</p><p>Переактивировать фаервол, чтобы сработали правила NAT и политика форвардинга пакетов, которые были добавлены в файл:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo ufw disable
</span></span><span style=display:flex><span>sudo ufw enable
</span></span></code></pre></div><h3 id=запуск-openvpn-сервера>Запуск OpenVPN сервера
<a class=anchor href=#%d0%b7%d0%b0%d0%bf%d1%83%d1%81%d0%ba-openvpn-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo systemctl start openvpn@server
</span></span></code></pre></div><p>Проверьте состояние сервера:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo systemctl status openvpn@server
</span></span></code></pre></div><p>Проверить интерфейс, на котором сервер держит подключенных клиентов:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ip addr show tun1
</span></span></code></pre></div><p>Если все в порядке и не требует исправлений, добавить службу <code>openvpn@server</code> в автозагрузку:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo systemctl enable openvpn@server
</span></span></code></pre></div><h2 id=клиент>Клиент
<a class=anchor href=#%d0%ba%d0%bb%d0%b8%d0%b5%d0%bd%d1%82>#</a></h2><p>Ниже показано формирования конфигурации для VPN клиента. Так как нет необходимости в разделении доступа разных клиентов, а VPN используется исключительно как удаленный доступ в интернет, то конфигурация клиента будет тоже одна единственная как и один единственный созданный клиентский сертификат.</p><p>Создайте файл в своей домашней директории с конфигурацией клиента. В параметре <code>remote</code> вместо 1.2.3.4 укажите IP адрес вашего сервера (к которому будет подключаться клиент) и порт, если вы его изменили для сервера:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tee ~/client.ovpn <span style=color:#e6db74>&lt;&lt;EOT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>dev tun
</span></span></span><span style=display:flex><span><span style=color:#e6db74>client
</span></span></span><span style=display:flex><span><span style=color:#e6db74>remote 1.2.3.4 1194 tcp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>nobind
</span></span></span><span style=display:flex><span><span style=color:#e6db74>verb 3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>server-poll-timeout 10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>; Если TLS не используется, то заменить шифр AES-256-GCM на AES-256-CBC
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ncp-ciphers AES-256-GCM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cipher AES-256-GCM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>; Если используется RouterOS, то раскомментировать следующую строку
</span></span></span><span style=display:flex><span><span style=color:#e6db74>;auth sha1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>reneg-sec 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>remote-cert-tls server
</span></span></span><span style=display:flex><span><span style=color:#e6db74>tls-version-min 1.2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384:TLS-ECDHE-ECDSA-WITH-AES-256-GCM-SHA384
</span></span></span><span style=display:flex><span><span style=color:#e6db74>; Для LINUX клиента раскомментировать три следующие строки
</span></span></span><span style=display:flex><span><span style=color:#e6db74>;script-security 2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>;up /etc/openvpn/update-resolv-conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>;down /etc/openvpn/update-resolv-conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOT</span>
</span></span></code></pre></div><p>Далее, как это было при формировании конфигурации сервера, добавляем в файл конфигурации клиента сертификаты и ключи. Обратите внимание, что сертификат и ключ используется <strong>клиентский</strong>, а не серверный:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;ca&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>cat pki/ca.crt | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/ca&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;cert&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>cat pki/issued/client.crt | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/cert&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;key&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>cat pki/private/client.key | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/key&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Если TLS-ключ не был создан - следующие строки не выполнять</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;tls-crypt&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>cat pki/easytls/tls-crypt.key | tee -a ~/client.ovpn
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;&lt;/tls-crypt&gt;&#34;</span> | tee -a ~/client.ovpn
</span></span></code></pre></div><h3 id=настройка-клиента>Настройка клиента
<a class=anchor href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-%d0%ba%d0%bb%d0%b8%d0%b5%d0%bd%d1%82%d0%b0>#</a></h3><p>Скопируйте файл <code>client.ovpn</code> на ваш компьютер и/или смартфон, установите <a href=https://openvpn.net/vpn-client/>OpenVPN клиент</a> и просто откройте в нем файл <code>client.ovpn</code>.</p><h4 id=linux>Linux
<a class=anchor href=#linux>#</a></h4><p>Скопируйте файл <code>client.ovpn</code> в каталог /etc/openvpn. Затем раскомментируйте в нем строки:</p><pre tabindex=0><code>script-security 2
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf
</code></pre><p>И запустите службу openvpn:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo systemctl start openvpn@client
</span></span></code></pre></div><h2 id=routeros-и-mikrotik>RouterOS и MikroTik
<a class=anchor href=#routeros-%d0%b8-mikrotik>#</a></h2><p>Операционная система RouterOS в оборудовании MikroTik не поддерживает TLS аутентификацию, поэтому вместо шифра (cipher) <code>AES-256-GCM</code> нужно использовать <code>AES-256-CBC</code>. Разница между <strong>GCM</strong> и <strong>CBC</strong>, помимо прочего, заключается во встроенном алгоритме аутентификации. Также следует явно указать аутентификацию <code>sha1</code> в конфигурации сервера и в конфигурации остальных клиентов.</p><p>Также в конфигурации <strong>сервера</strong> необходимо закомментировать или удалить целиком блок с TLS-ключем, начинающийся с <code>&lt;tls-crypt></code> и заканчивающийся <code>&lt;/tls-crypt></code>, либо не добавлять его туда изначально (если вы не создавали TLS-ключи, то и добавлять будет нечего).</p><h3 id=создание-подключения-на-mikrotik>Создание подключения на MikroTik
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be%d0%b4%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d1%8f-%d0%bd%d0%b0-mikrotik>#</a></h3><ol><li>Загрузите файл <code>client.ovpn</code> в маршрутизатор</li><li>В меню Winbox перейдите в <strong>System</strong> » <strong>Certificates</strong> и импортируйте файл <code>client.ovpn</code> задав ему понятное имя сертификата, например «digitalocean-vpn». В результате будет импортирован СЦ (ca.crt) с именем digitalocean-vpn и клиентский сертификат с приватным ключем с именем digitalocean-vpn_1, который лучше переименовать, например, в <strong>digitalocean-vpn_client</strong>.</li><li>В меню <strong>PPP</strong> создайте <strong>OVPN Client</strong>, где нужно будет указать: IP-адрес сервера, порт (по умолчанию 1194), Mode: ip, User: none, Certificate: digitalocean-vpn_client, Cipher: aes 256</li></ol></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-denisbondar-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#регистрация-собственного-виртуального-сервера>Регистрация собственного виртуального сервера</a><ul><li><a href=#создание-капли>Создание капли</a></li></ul></li><li><a href=#установка>Установка</a><ul><li><a href=#openvpn>OpenVPN</a></li><li><a href=#easyrsa-3>EasyRSA-3</a></li><li><a href=#easytls>EasyTLS</a></li></ul></li><li><a href=#инфраструктура-открытых-ключей-pki>Инфраструктура открытых ключей (PKI)</a><ul><li><a href=#что-такое-easyrsa>Что такое EasyRSA</a></li><li><a href=#инициализация-pki>Инициализация PKI</a></li><li><a href=#предварительная-конфигурация>Предварительная конфигурация</a></li><li><a href=#создание-главного-сертификата--ca>Создание главного сертификата — CA</a></li><li><a href=#создание-сертификата-сервера>Создание сертификата сервера</a></li><li><a href=#создание-сертификата-клиента>Создание сертификата клиента</a></li><li><a href=#инициализация-и-создание-tls-ключа>Инициализация и создание TLS-ключа</a></li></ul></li><li><a href=#сервер>Сервер</a><ul><li><a href=#конфигурация-openvpn-сервера>Конфигурация OpenVPN сервера</a></li><li><a href=#настройка-сети-сервера>Настройка сети сервера</a></li><li><a href=#запуск-openvpn-сервера>Запуск OpenVPN сервера</a></li></ul></li><li><a href=#клиент>Клиент</a><ul><li><a href=#настройка-клиента>Настройка клиента</a></li></ul></li><li><a href=#routeros-и-mikrotik>RouterOS и MikroTik</a><ul><li><a href=#создание-подключения-на-mikrotik>Создание подключения на MikroTik</a></li></ul></li></ul></nav></div></aside></main></body></html>