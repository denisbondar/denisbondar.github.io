<!doctype html><html lang=uk dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Персональный почтовый сервер # Если у Вас онлайн магазин или блог или любой другой сайт, которому требуется рассылать почтовые сообщения клиентам и Вы хотите, чтобы почта отправлялась с вашего домена — Вам нужен собственный SMTP сервер, построенный с использованием правильно настроенных Postfix и DKIM. Вы можете воспользоваться уже готовыми многофункциональными SMTP серверами, которые предоставляют различные почтовые службы, например, «GMAIL» или «Yandex.Почта», но если Вам нужен именно ваш собственный сервер, то эта небольшая, но полноценная инструкция для Вас!"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Персональный почтовый сервер"><meta property="og:description" content="Персональный почтовый сервер # Если у Вас онлайн магазин или блог или любой другой сайт, которому требуется рассылать почтовые сообщения клиентам и Вы хотите, чтобы почта отправлялась с вашего домена — Вам нужен собственный SMTP сервер, построенный с использованием правильно настроенных Postfix и DKIM. Вы можете воспользоваться уже готовыми многофункциональными SMTP серверами, которые предоставляют различные почтовые службы, например, «GMAIL» или «Yandex.Почта», но если Вам нужен именно ваш собственный сервер, то эта небольшая, но полноценная инструкция для Вас!"><meta property="og:type" content="article"><meta property="og:url" content="https://denisbondar.github.io/post/postfix-dkim-spf-tls-dmarc/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-10-24T00:00:00+00:00"><meta property="article:modified_time" content="2020-10-24T00:00:00+00:00"><title>Персональный почтовый сервер | Notes</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.6e9dc01763201e1138d92988ddb76ac12def039312e5473a6847a96d89bc05af.css integrity="sha256-bp3AF2MgHhE42SmI3bdqwS3vA5MS5Uc6aEepbYm8Ba8=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/uk.search.min.7d4495b5af445e69c6fb87b3622a37b0b66bb73535de0d48d853f2e4f916d57d.js integrity="sha256-fUSVta9EXmnG+4ezYio3sLZrtzU13g1I2FPy5PkW1X0=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-8991816-14","auto"),ga("send","pageview"))</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Notes</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Пошук aria-label=Пошук maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/post/openvpn-server/>OpenVPN Server</a></li><li><a href=/post/alpine-php-nginx-logrotate-docker-image/>Докеризация PHP-приложения в единый Docker-образ Alpine+PHP+NGINX+logrotate</a></li><li><a href=/post/postfix-dkim-spf-tls-dmarc/ class=active>Персональный почтовый сервер</a></li><li><a href=/post/winbox-wine-tahoma-font/>Winbox в Wine как исправить кривой шрифт</a></li><li><a href=/post/how-to-install-docker-on-linux/>Установка Docker в Linux</a></li><li><a href=/post/phpstorm_docker_xdebug/>PhpStorm + Docker + Xdebug</a></li><li><a href=/post/zfs-manual-rus/>ZFS — Справочник команд</a></li><li><a href=/post/midi-keybiard-jack-bitwig-studio/>Как подключить MIDI клавиатуру к Bitwig Studio</a></li><li><a href=/post/how-to-install-debian-8/>Как установить Debian 8 без знаний и опыта</a></li><li><a href=/post/install-nginx-php7-mysql57-mariadb11-debian-ubuntu/>Установка Nginx 1.13, PHP 7, MySQL 5.7, MariaDB 10.1, PostgreSQL 11 в Debian и Ubuntu</a></li><li><a href=/post/asterisk-13-chan_dongle-debian-8/>Установка Asterisk 13 + chan_dongle (E1550, E1750) на Debian 8</a></li><li><a href=/post/asterisk11-chan_dongle_e1550-ubuntu14/>Asterisk11 Chan_dongle_e1550 Ubuntu14</a></li><li><a href=/post/asterisk-example-2-dongle-call-management/>Asterisk. Пример 2 — SIP и DONGLE</a></li><li><a href=/post/apache24php7win10/>Apache 2.4 + PHP 7 на Windows 7­, 10</a></li><li><a href=/post/simply-install-freebsd/>Как установить FreeBSD с флешки</a></li><li><a href=/post/resize-gpt-psrtition-freebsd/>Изменить размер раздела GPT FreeBSD vmWare</a></li><li><a href=/post/material-design-product-icon-ai/>Как создать иконку приложения в стиле Material Design. Наиболее правильная инструкция</a></li><li><a href=/post/asterisk-example-1-call-between-two-sip-line/>Asterisk. Пример 1 — вызов между двумя линиями SIP</a></li><li><a href=/post/manual-freebsd-install/>Ручная установка FreeBSD на USB flash или HDD</a></li><li><a href=/post/apache24php56win7/>Apache 2.4 + PHP 5.6 + MySQL 5.6 на Windows 7, 10</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Персональный почтовый сервер</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#dns>DNS</a><ul><li><a href=#a-запись>A-запись</a></li><li><a href=#mx-запись>MX-запись</a></li><li><a href=#ptr-запись>PTR-запись</a></li><li><a href=#подтвердить-домен-в-google>Подтвердить домен в Google</a></li></ul></li><li><a href=#postfix>Postfix</a></li><li><a href=#tls-шифрование>TLS-шифрование</a></li><li><a href=#spf-sender-policy-framework>SPF (Sender Policy Framework)</a></li><li><a href=#dkim-domainkeysidentifiedmail>DKIM (DomainKeysIdentifiedMail)</a><ul><li><a href=#создание-ключей>Создание ключей</a></li><li><a href=#настройки-dns>Настройки DNS</a></li><li><a href=#postfix-1>Postfix</a></li></ul></li><li><a href=#проверка-1>Проверка</a></li></ul></nav></aside></header><article class=markdown><h1 id=персональный-почтовый-сервер>Персональный почтовый сервер
<a class=anchor href=#%d0%bf%d0%b5%d1%80%d1%81%d0%be%d0%bd%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b9-%d0%bf%d0%be%d1%87%d1%82%d0%be%d0%b2%d1%8b%d0%b9-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80>#</a></h1><p>Если у Вас онлайн магазин или блог или любой другой сайт, которому требуется рассылать почтовые сообщения клиентам и Вы хотите, чтобы почта отправлялась с вашего домена — Вам нужен собственный SMTP сервер, построенный с использованием правильно настроенных Postfix и DKIM. Вы можете воспользоваться уже готовыми многофункциональными SMTP серверами, которые предоставляют различные почтовые службы, например, «GMAIL» или «Yandex.Почта», но если Вам нужен именно ваш собственный сервер, то эта небольшая, но полноценная инструкция для Вас!</p><p>Как всегда, инструкция состоит из простых коротких шагов с минимумом текста. По возможности, конечно же…</p><p>Будет рассмотрена установка почтового агента (SMTP) Postfix, а также DKIM, TLS и всех необходимых записей на NS-серверах, чтобы добиться результата в 10 баллов на <a href=http://www.mail-tester.com/>mail-tester.com</a>.</p><p>Все примеры показаны на базе ОС Debian. Они также должны подойти без изменения для Ubuntu. Также за основу берется настройка почты для моего домена denisbondar.com.</p><h2 id=dns>DNS
<a class=anchor href=#dns>#</a></h2><p>Здесь и далее под доменом будет пониматься полное имя домена (FQDN). Я буду использовать везде имя своего домена denisbondar.com. Обратите внимание на то, что мой блог имеет адрес blog.denisbondar.com.</p><p>Для работы нашего почтового сервера необходимы три основные обязательные записи на NS-сервере, обслуживающем этот домен.</p><p>Вам необходимо открыть раздел управления серверами имен (NS) панели управления вашим хостингом. Она может называться как-то иначе, например, в DigitalOcean она называется Domains.</p><h3 id=a-запись>A-запись
<a class=anchor href=#a-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d1%8c>#</a></h3><p>Для вашего домена должна быть обязательно настроена <strong>A-запись</strong> (соответствие IP-адреса доменному имени). Но если на этом же домене работает ваш сайт, то запись уже есть. В моем случае сайт имеет адрес blog.denisbondar.com, а в качестве почтового я буду использовать denisbondar.com, поэтому я должен создать <strong>A-запись</strong> для <strong>denisbondar.com</strong>. Если у вас несколько субдоменов, то для каждого из них должна быть такая запись.</p><h3 id=mx-запись>MX-запись
<a class=anchor href=#mx-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d1%8c>#</a></h3><p>Эта запись указывает, какой <strong>mail exchanger</strong> используется в нашем домене. Так как мы используем наш собственный mail exchanger, то необходимо добавить следующую запись:</p><pre tabindex=0><code>@ IN MX 0 &#34;denisbondar.com.&#34;
</code></pre><p>Если у вас несколько субдоменов, то для каждого из них должна быть такая запись.</p><p>В пользовательском интерфейсе DigitailOcean это выглядит следующим образом.
<img src=image-9.png alt>
<em>MX-запись для домена в панели управления DigitalOcean</em></p><h3 id=ptr-запись>PTR-запись
<a class=anchor href=#ptr-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d1%8c>#</a></h3><p>Также Вам необходимо настроить PTR-запись для Вашего IP-адреса сервера. Обычно это делается автоматически, если Вы пользуетесь услугами хостинговых компаний. Но в некоторых случаях, если Ваш сервер находится у Вас, а не в облаках, то эту настройку должен выполнить ваш интернет-провайдер, которому принадлежит IP-адрес вашего сервера. Также обратите внимание, есть ли у вас PTR для IPv6 — это пригодится далее.</p><p>В DigitalOcean ничего для этого делать не нужно — там PTR создается автоматически и соответствует указанному доменному имени вашего Droplet. У меня это выглядит вот так.
<img src=image-5.png alt>
<em>PTR-запись для моего IP-адреса в панели DigitalOcean</em></p><h3 id=подтвердить-домен-в-google>Подтвердить домен в Google
<a class=anchor href=#%d0%bf%d0%be%d0%b4%d1%82%d0%b2%d0%b5%d1%80%d0%b4%d0%b8%d1%82%d1%8c-%d0%b4%d0%be%d0%bc%d0%b5%d0%bd-%d0%b2-google>#</a></h3><p>Google может и скорее всего будет отклонять почту с неподтвержденных доменов. Поэтому подтвердите домен перейдя по ссылке <a href=https://postmaster.google.com>https://postmaster.google.com</a> — это займет всего минуту.</p><p>Больше информации <a href="https://support.google.com/mail/answer/9981691?hl=ru">здесь</a>.</p><h2 id=postfix>Postfix
<a class=anchor href=#postfix>#</a></h2><p>Установка и настройка SMTP агента Postfis.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install -y postfix mailutils
</span></span></code></pre></div><p>Во время установки вам нужно будет выбрать Internet Site и далее указать ваш домен (в моем случае это denisbondar.com).</p><p>После установки отредактируйте файл /etc/postfix/main.cf</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/postfix/main.cf
</span></span></code></pre></div><p>Найдите строку <code>inet_interfaces</code> и замените ее значение по умолчанию <code>all</code> на <code>loopback-only</code>. Это необходимо для того чтобы почтовый сервер принимал подключения только на локальном интерфейсе. Нам ведь нужно чтобы только наш сайт/блог/магазин мог отправлять почту через наш сервер, а не весь интернет. Если в будущем понадобится отправлять почту с других ваших серверов через этот, нужно будет добавить интерфейсы здесь.</p><p>Найдите строку <code>mydestination</code> и отредактируйте ее указав все домены, с которых сервер будет отправлять почту (через запятую):</p><pre tabindex=0><code>mydestination = $myhostname, denisbondar.com
</code></pre><p>Здесь первым в списке идет переменная <code>$myhostname</code>, значение которой соответствует имени вашего хоста. В моем случае оно <strong>denisbondar.com</strong> и конкретно в моем случае нет смысла также добавлять <strong>denisbondar.com</strong> в этот список, но у Вас имя хоста и почтовый домен могут отличаться. Обратите на это внимание.</p><p>Если ваш хостер не поддерживает <strong>PTR IPv6</strong>, то нужно оставить только протокол IPv4, иначе при попытке работы через IPv6 возникнут проблемы с PTR:</p><pre tabindex=0><code>inet_protocols = ipv4
</code></pre><p>Работа с файлом main.cf завершена.</p><p>Далее настроим псевдонимы, если это необходимо. Было бы правильным это сделать. Системные сообщения на сервере обычно отправляются пользователю root. Мы же можем указать в качестве псевдонима для root настоящий адрес электронной почты, на который будут приходить эти письма.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;root: myreadlemail@gmail.com&#34;</span> | sudo tee -a /etc/aliases
</span></span><span style=display:flex><span>sudo newaliases
</span></span></code></pre></div><p>Вместо <code>myreadlemail@gmail.com</code> укажите свой настоящий адрес электронной почты.</p><p>Теперь перезагрузите postfix.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart postfix
</span></span></code></pre></div><p>На этом базовая настройка Postfix завершена и уже можно проверить его работу. Отправьте почту пользователю root или же на любой другой адрес электронной почты для проверки (укажите его вместо root):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Test email body&#34;</span> | mail -s <span style=color:#e6db74>&#34;Test email subject&#34;</span> root
</span></span></code></pre></div><h2 id=tls-шифрование>TLS-шифрование
<a class=anchor href=#tls-%d1%88%d0%b8%d1%84%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5>#</a></h2><p>Шифрование можно не применять, однако почтовые клиенты ваших получателей будут видеть красный предупреждающий замок, что письма не зашифрованы. Например, gmail отображает такие письма следующим образом:</p><p><img src=image-0.png alt>
<em>Отсутствие шифрования письма выглядит как красный замок</em></p><p><img src=image-1.png alt>
<em>Подробная информация. Домен не шифрует почту.</em></p><p>Исправим это.</p><p>Создадим сертификат (это всё одна строка):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo openssl req -new -nodes -x509 -days <span style=color:#ae81ff>3650</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -out /etc/postfix/smtpd.pem <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -keyout /etc/postfix/smtpd.pem
</span></span></code></pre></div><p>И снова отредактируем файл <strong>/etc/postfix/main.cf</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/postfix/main.cf
</span></span></code></pre></div><p>Отыщите в файле блок настроек TLS и измените либо добавьте параметры в нем следующим образом:</p><pre tabindex=0><code>smtp_use_tls = yes
smtpd_use_tls = yes
smtpd_tls_auth_only = yes
smtp_tls_note_starttls_offer = yes
smtpd_tls_key_file = /etc/postfix/smtpd.pem
smtpd_tls_cert_file = /etc/postfix/smtpd.pem
smtpd_tls_CAfile = /etc/postfix/smtpd.pem
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes
smtpd_tls_session_cache_timeout = 3600s
tls_random_source = dev:/dev/urandom
</code></pre><p>Теперь необходимо настроить Postfix на прием подключений на TLS порту (465/SMTPS). Отредактируйте файл <strong>/etc/postfix/master.cf</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/postfix/master.cf
</span></span></code></pre></div><p>Необходимо дополнительно раскомментировать строки таким образом, чтобы команда выглядела вот так (каждый параметр в этом файле находится в отдельной строке, так что придется найти их в отдельности и расскомментировать и изменить при необходимости):</p><pre tabindex=0><code>smtps inet n - y - - smtpd
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
</code></pre><p>Перезапустите Postfix и снова проверьте его работу.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart postfix
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Test email body with TLS&#34;</span> | mail -s <span style=color:#e6db74>&#34;Test email subject with TLS&#34;</span> root
</span></span></code></pre></div><p>Теперь в почтовом клиенте вы должны увидеть, что письмо зашифровано.
<img src=image-2.png alt>
<em>Красного замка нет</em></p><p><img src=image-3.png alt>
<em>Подробная информация с TLS шифрованием</em></p><h2 id=spf-sender-policy-framework>SPF (Sender Policy Framework)
<a class=anchor href=#spf-sender-policy-framework>#</a></h2><p>SPF позволяет настроить список различных серверов, которые могут отправлять почту с вашего домена.</p><p>Эта настройка производится на NS-серверах, обслуживающих Ваш домен.</p><p>Вам необходимо добавить запись типа <strong>TXT</strong> для вашего домена, которая определяет, какие хосты могут отправлять почту используя ваш домен. Добавим сюда только IP-адреса нашего сервера, чтобы только наш сервер считался авторизованным. Для всех остальных будет применено правило «жесткий отказ» <code>-all</code>, чтобы гарантировать, что с нашего домена никакие другие серверы не смогут отправлять сообщения.</p><p>В моем случае я добавляю запись:</p><pre tabindex=0><code>@ IN TXT &#34;v=spf1 a mx ip4:207.154.240.75 -all&#34;
</code></pre><p>Если у вас несколько субдоменов (сайтов), то нужно добавить такую запись для каждого из них.</p><p>В панели DigitalOcean это выглядит следующим образом.
<img src=image-12.png alt>
<em>Добавление TXT-записи SPF в консоли DigitalOcean</em></p><h2 id=dkim-domainkeysidentifiedmail>DKIM (DomainKeysIdentifiedMail)
<a class=anchor href=#dkim-domainkeysidentifiedmail>#</a></h2><p>DKIM — цифровая подпись, подтверждающая подлинность отправителя.</p><p>Необходимо установить пакет OpenDKIM и произвести его настройку.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y opendkim opendkim-tools
</span></span></code></pre></div><p>Стандартный файл конфигурации <strong>/etc/opendkim.conf</strong> содержит слишком много комментариев и лишних опций, поэтому лучше сразу переименовать его в backup на всякий случай и начать работу с новым конфигом.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mv /etc/opendkim.conf /etc/opendkim.conf.backup
</span></span><span style=display:flex><span>sudo nano /etc/opendkim.conf
</span></span></code></pre></div><p>Приведём файл к виду:</p><pre tabindex=0><code>AutoRestart         Yes
AutoRestartRate     10/1h
Background          yes
DNSTimeout          5
Umask               002
Syslog              yes
SyslogSuccess       Yes
LogWhy              Yes
Canonicalization    relaxed/simple
ExternalIgnoreList  refile:/etc/opendkim/trusted.hosts
InternalHosts       refile:/etc/opendkim/trusted.hosts
KeyTable            refile:/etc/opendkim/key.table
SigningTable        refile:/etc/opendkim/signing.table
Mode                sv
PidFile             /run/opendkim/opendkim.pid
SignatureAlgorithm  rsa-sha256
UserID              opendkim
Socket              local:/var/spool/postfix/opendkim/opendkim.sock
</code></pre><p>Создадим все необходимые каталоги и файлы:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir -p /etc/opendkim/keys
</span></span><span style=display:flex><span>sudo chown -R opendkim:opendkim /etc/opendkim
</span></span><span style=display:flex><span>sudo chmod go-rw /etc/opendkim/keys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo mkdir -p /var/spool/postfix/opendkim
</span></span><span style=display:flex><span>sudo chown opendkim:opendkim /var/spool/postfix/opendkim
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo touch /etc/opendkim/key.table
</span></span><span style=display:flex><span>sudo touch /etc/opendkim/signing.table
</span></span></code></pre></div><p>Теперь в файл <strong>/etc/opendkim/trusted.hosts</strong> и помещаем доверенные узлы, с которых может осуществляться отправка. В будущем, если нужно будет разрешить отправку почты с каких-то еще узлов, нужно будет добавить их в этот файл.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee -a /etc/opendkim/trusted.hosts <span style=color:#e6db74>&lt;&lt;EOT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>127.0.0.0/8
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[::ffff:127.0.0.0]/104
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[::1]/128
</span></span></span><span style=display:flex><span><span style=color:#e6db74>localhost
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>denisbondar.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>*.denisbondar.com
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOT</span>
</span></span></code></pre></div><p>Теперь редактируем файл <strong>/etc/default/opendkim</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/default/opendkim
</span></span></code></pre></div><p>Здесь нужно изменить (добавить) сокет, на котором OpenDKIM будет принимать соединения.</p><pre tabindex=0><code>SOCKET=local:/var/spool/postfix/opendkim/opendkim.sock
</code></pre><p>Включаем и запускаем службу opendkim.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable opendkim
</span></span><span style=display:flex><span>sudo systemctl restart opendkim
</span></span></code></pre></div><h3 id=создание-ключей>Создание ключей
<a class=anchor href=#%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d0%b5-%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%b9>#</a></h3><p>Описанные действия также необходимо будет выполнить при добавлении новых доменов, с которых ваш почтовый сервер будет уполномочен отправлять почту. Например, если у вас на сервере появится еще один сайт, работающий на другом домене, почта с которого должна отправляться с его доменного имени.</p><p>Для создания сертификата можно воспользоваться онлайн инструментом <a href=https://dkimcore.org/tools/keys.html>dkimcore.org</a> или же создать самому следующим образом:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir -p /etc/opendkim/keys/denisbondar.com
</span></span><span style=display:flex><span>sudo opendkim-genkey -b <span style=color:#ae81ff>2048</span> --selector mail --domain denisbondar.com -D /etc/opendkim/keys/denisbondar.com/
</span></span><span style=display:flex><span>sudo chown opendkim:opendkim /etc/opendkim/keys/denisbondar.com/mail.private
</span></span><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>600</span> /etc/opendkim/keys/denisbondar.com/mail.private
</span></span></code></pre></div><p>В результате будет создана пара ключей: <strong>mail.private</strong> (закрытый) и <strong>mail.txt</strong> (открытый). Открытый ключ далее необходимо будет прописать в NS-сервере. В данном случае <strong>mail</strong> — это селектор (он может быть любым).</p><p>Если доменов/субдоменов несколько, нужно повторить эту процедуру для каждого из них.</p><p>Создаем таблицу <strong>/etc/opendkim/key.table</strong> — в ней находится список соответствий между селекторами, доменами и файлами с закрытыми ключами.</p><p>Формат таблицы следующий:</p><pre tabindex=0><code>&lt;селектор&gt;._domainkey.&lt;домен&gt; &lt;домен&gt;:&lt;селектор&gt;:&lt;путь к закрытому ключу&gt;
</code></pre><p>В нашем случае таблица будет создана следующим образом:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;mail._domainkey.denisbondar.com denisbondar.com:mail:/etc/opendkim/keys/denisbondar.com/mail.private&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | sudo tee -a /etc/opendkim/key.table
</span></span></code></pre></div><p>Создаем таблицу <strong>/etc/opendkim/signing.table</strong> — в ней находится список соответствия между определенными email-адресами и записями в <code>key.table</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;*@denisbondar.com mail._domainkey.denisbondar.com&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | sudo tee -a /etc/opendkim/signing.table
</span></span></code></pre></div><p>Перезапускаем OpenDKIM.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart opendkim
</span></span></code></pre></div><h3 id=настройки-dns>Настройки DNS
<a class=anchor href=#%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b8-dns>#</a></h3><p>Теперь необходимо внести следующие изменения в настройки вашего домена (NS-серверов).</p><p>Необходимо создать запись типа <strong>TXT</strong> и содержимым из файла открытого ключа.</p><p>Выводим в консоль содержимое файла открытого ключа:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cat /etc/opendkim/keys/denisbondar.com/mail.txt | awk -F<span style=color:#e6db74>&#39;&#34;&#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span> ORS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span></code></pre></div><p>Теперь создаем TXT-запись следующего вида (значением записи является заключенная в кавычки строка, полученная по команде выше):</p><pre tabindex=0><code>mail._domainkey IN TXT &#34;v=DKIM1; ...&#34;
</code></pre><p>Добавьте также следующие TXT записи (для каждого своего субдомена):</p><pre tabindex=0><code>_domainkey IN TXT &#34;o=~; r=postmaster@denisbondar.com&#34;
_dmarc IN TXT &#34;v=DMARC1; p=none&#34;
</code></pre><h4 id=проверка>Проверка
<a class=anchor href=#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0>#</a></h4><p>Для проверки ключа, выполните:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo opendkim-testkey -d denisbondar.com -s mail -vvv
</span></span></code></pre></div><h3 id=postfix-1>Postfix
<a class=anchor href=#postfix-1>#</a></h3><p>Добавить пользователя postfix в группу opendkim:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo adduser postfix opendkim
</span></span></code></pre></div><p>Теперь необходимо внести изменения в <strong>/etc/postfix/main.cf</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/postfix/main.cf
</span></span></code></pre></div><p>Редактируем либо добавляем следующие строки. Так как Postfix работает в chroot, то путь к файловому сокету будет относительно chroot:</p><pre tabindex=0><code>milter_protocol = 6
milter_default_action = accept
smtpd_milters = local:opendkim/opendkim.sock
non_smtpd_milters = $smtpd_milters
</code></pre><p>Перезапускаем Postfix.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart opendkim postfix
</span></span></code></pre></div><h2 id=проверка-1>Проверка
<a class=anchor href=#%d0%bf%d1%80%d0%be%d0%b2%d0%b5%d1%80%d0%ba%d0%b0-1>#</a></h2><p>Для полной проверки воспользуемся сервисом <a href=http://www.mail-tester.com/>mail-tester.com</a>.</p><p>На странице сервиса отображается адрес электронной почты, на который следует отправить письмо для теста. Копируем его и отправляем на него письмо из консоли сервера:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Test letter.&#34;</span> | mail <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -s <span style=color:#e6db74>&#34;Testing denisbondar.com&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -a <span style=color:#e6db74>&#34;Smtp: localhost:25&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -a <span style=color:#e6db74>&#34;From: blog@denisbondar.com&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -a <span style=color:#e6db74>&#34;List-Unsubscribe: &lt;mailto: unsubscribe@denisbondar.com?subject=unsubscribe&gt;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    test-xxxxxxx@srv1.mail-tester.com
</span></span></code></pre></div><p>После чего нажимаем <strong>«Затем проверить оценку»</strong>.</p><p>В приведенном выше примере отправки тестового письма содержится заголовок List-Unsubscribe. В данном случае он необходим только для того чтобы получить максимальный бал. Очень желательно, чтобы ваши письма по возможности имели такой заголовок — это требование для рассылок. В личной переписке в этом заголовке, конечно же, смысла нет.</p><p>Ну и, долгожданный результат!</p><p><img src=image-11.png alt>
<em>Всё настроено превосходно</em></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-denisbondar-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#dns>DNS</a><ul><li><a href=#a-запись>A-запись</a></li><li><a href=#mx-запись>MX-запись</a></li><li><a href=#ptr-запись>PTR-запись</a></li><li><a href=#подтвердить-домен-в-google>Подтвердить домен в Google</a></li></ul></li><li><a href=#postfix>Postfix</a></li><li><a href=#tls-шифрование>TLS-шифрование</a></li><li><a href=#spf-sender-policy-framework>SPF (Sender Policy Framework)</a></li><li><a href=#dkim-domainkeysidentifiedmail>DKIM (DomainKeysIdentifiedMail)</a><ul><li><a href=#создание-ключей>Создание ключей</a></li><li><a href=#настройки-dns>Настройки DNS</a></li><li><a href=#postfix-1>Postfix</a></li></ul></li><li><a href=#проверка-1>Проверка</a></li></ul></nav></div></aside></main></body></html>